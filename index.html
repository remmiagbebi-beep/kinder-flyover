<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kinder Scout 3D Flyover</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    html,body{
      margin:0;
      height:100%;
      background:#000;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
    }
    #map{ position:absolute; inset:0 }

    .ui{
      position:absolute;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:10;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* Button style */
    .btn{
      width:50px;
      height:50px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      border:3px solid #fff;
      cursor:pointer;
      background:linear-gradient(180deg,#EC2629,#b51d20);
      box-shadow:0 3px 10px rgba(0,0,0,.35);
      transition:.15s;
    }
    .btn:hover{
      background:linear-gradient(180deg,#3899EC,#297fc8);
    }

    /* Restore normal icon size for ALL buttons */
    .btn svg{
      fill:#fff;
      width:24px;
      height:24px;
      display:none;
    }
    .btn svg.active{ display:block }

    /* Speed button ONLY is 75% size */
    #iconSpeed{
      width:18px !important;
      height:18px !important;
    }

    /* Speed slider panel */
    .speed-wrap{ position:relative; width:50px; height:50px }

    .speed-panel{
      position:absolute;
      top:50%;
      right:60px;
      transform:translateY(-50%) scale(.98);
      opacity:0;
      pointer-events:none;
      width:230px;
      height:45px;
      display:flex;
      align-items:center;
      gap:12px;
      padding:0 10px;
      border-radius:9999px;
      border:3px solid #fff;
      background:linear-gradient(180deg,#EC2629,#b51d20);
      transition:opacity .18s,transform .18s;
      box-shadow:0 3px 10px rgba(0,0,0,.35);
    }
    .speed-wrap.open .speed-panel{
      opacity:1;
      transform:translateY(-50%) scale(1);
      pointer-events:auto;
    }

    /* Speed slider only */
    .speed-slider{
      flex:1;
      appearance:none;
      height:6px;
      border-radius:999px;
      background:linear-gradient(90deg,#fff,#fff8);
      outline:none;
    }
    .speed-slider::-webkit-slider-thumb{
      appearance:none;
      width:18px;
      height:18px;
      border-radius:50%;
      background:#fff;
      border:2px solid #EC2629;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      cursor:pointer;
    }
  </style>
</head>

<body>
<div id="map"></div>

<div class="ui">

  <!-- Play / Pause -->
  <button id="btnToggle" class="btn">
    <svg id="iconPlay"  class="active" viewBox="0 0 24 24"><polygon transform="translate(1,0)" points="5,3 19,12 5,21"></polygon></svg>
    <svg id="iconPause" viewBox="0 0 24 24"><rect x="6" y="4" width="5" height="16" rx="1.5"></rect><rect x="13" y="4" width="5" height="16" rx="1.5"></rect></svg>
  </button>

  <!-- Camera mode -->
  <button id="btnCam" class="btn">
    <svg id="iconCamCine" class="active" viewBox="0 0 24 24"><rect x="3" y="7" width="11" height="10" rx="2"/><polygon points="16,10 22,7.5 22,16.5 16,14"/></svg>

    <svg id="iconCamBird" xmlns="http://www.w3.org/2000/svg" viewBox="4.3333375 6.3333375 43.875 40.375" style="transform:translate(1px,1px)">
      <path fill="#fff" d="M41.965,20.694c-0.495-2.083-2.273-3.54-4.182-3.54c-1.816,0-3.717,1.149-5.184,2.522c-3.911-5.328-9.661-9.706-13.112-12.527c-0.713,1.656-1.029,3.449-1.029,5.271c0,1.999,0.395,4.832,1.042,6.768L26,19.667H5.121c2.5,5.762,7.472,9.976,13.329,12.333c-3.699,2.583-6.778,4.415-10.271,6.815c2.034,2.034,3.384,2.935,6.606,4.035c2.205-3.185,3.991-5.396,5.582-7.654c2.219,0.988,4.734,1.532,7.207,1.532c11.183,0,14.263-12.188,14.509-14.603c0.972-0.161,1.946-0.328,2.918-0.455C43.971,21.4,42.953,21.075,41.965,20.694z"/>
    </svg>

    <svg id="iconCamFree" viewBox="0 0 24 24"></svg>
  </button>

  <!-- Speed -->
  <div class="speed-wrap" id="speedWrap">
    <button id="btnSpeed" class="btn">
      <svg id="iconSpeed" class="active" viewBox="0 0 24 24">
        <path d="M4 5l8 7-8 7V5zm9 0l8 7-8 7V5z" />
      </svg>
    </button>

    <!-- Slider panel (NO icon inside) -->
    <div class="speed-panel" id="speedPanel">
      <input id="speed" class="speed-slider" type="range" min="0.1" max="5" step="0.05" value="0.35"/>
    </div>
  </div>

</div>

<!-- JS imports -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>

<script>
/* EVERYTHING BELOW IS UNCHANGED FROM YOUR WORKING VERSION */

mapboxgl.accessToken="pk.eyJ1IjoicmVtbWlhZ2JlYmkiLCJhIjoiY21odHRrYTQzMTk0bjJqcjE1b2xhZ2FraSJ9.nTCz33gX0gQt3T4A6VD0oQ";

const GPX_URL="https://ca60d944-6ce0-4824-b204-1ba31932152f.filesusr.com/ugd/a3a8b8_063190b585b948a6ad31077eef19e6fa.gpx";
const HAND_ICON="https://raw.githubusercontent.com/remmiagbebi-beep/kinder-flyover/main/icons/hand.svg?v="+Date.now();
const SPEED_ICON="https://raw.githubusercontent.com/remmiagbebi-beep/kinder-flyover/main/icons/fast-forward.svg?v="+Date.now();

const START_ZOOM=15.7,CENTER_SMOOTH=0.06,MAX_TURN_RATE=4,STEP_KM=0.02;

function forceWhite(svg){
  svg.querySelectorAll("*").forEach(n=>{
    if(n.getAttribute("fill")!=="none")n.setAttribute("fill","#fff");
    if(n.hasAttribute("stroke"))n.setAttribute("stroke","#fff");
  });
}

/* Load speed button icon (75% size only) */
(async()=>{
  try{
    const r=await fetch(SPEED_ICON,{cache:"no-store"});
    const t=await r.text();
    const svg=new DOMParser().parseFromString(t,"image/svg+xml").querySelector("svg");
    if(svg){
      forceWhite(svg);
      svg.id="iconSpeed";
      svg.classList.add("active");
      svg.style.width="18px";
      svg.style.height="18px";
      document.getElementById("iconSpeed").replaceWith(svg);
    }
  }catch{}
})();

/* Load hand icon */
(async()=>{
  try{
    const r=await fetch(HAND_ICON,{cache:"no-store"});
    const t=await r.text();
    const svg=new DOMParser().parseFromString(t,"image/svg+xml").querySelector("svg");
    if(svg){
      forceWhite(svg);
      svg.id="iconCamFree";
      svg.style.width="24px";
      svg.style.height="24px";
      svg.style.transform="translate(2px,0)";
      document.getElementById("iconCamFree").replaceWith(svg);
    }
  }catch{}
})();

/* Map + animation code unchanged */
const map=new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/satellite-streets-v12",
  center:[-1.8743,53.3832],
  zoom:START_ZOOM,
  pitch:75,
  bearing:-20,
  antialias:true
});

let route=null,routeLen=0,progress=0,playing=false,camMode="follow",userOverride=false;
let camCenter=null,camBearing=null,lastTs=0;

async function fetchText(u){
  try{const r=await fetch(u);if(r.ok)return await r.text();}catch{}
  try{const r=await fetch("https://corsproxy.io/?"+encodeURIComponent(u));if(r.ok)return await r.text();}catch{}
  return "";
}
function parseGpx(text){
  const xml=new DOMParser().parseFromString(text,"application/xml");
  return toGeoJSON.gpx(xml).features.find(f=>f.geometry?.type==="LineString");
}

async function addArrow(){
  if(map.hasImage("arrow"))return;
  const c=document.createElement("canvas");
  c.width=c.height=96;
  const ctx=c.getContext("2d");
  ctx.translate(48,48);
  ctx.beginPath();
  ctx.moveTo(40,0);
  ctx.lineTo(-24,-25);
  ctx.lineTo(-24,25);
  ctx.closePath();
  ctx.strokeStyle="#EC2629";
  ctx.fillStyle="#fff";
  ctx.lineWidth=3;
  ctx.stroke();
  ctx.fill();
  map.addImage("arrow",await createImageBitmap(c),{pixelRatio:2});
}

map.on("load",async()=>{

  map.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"});
  map.setTerrain({source:"mapbox-dem",exaggeration:1});

  map.addLayer({id:"sky",type:"sky",paint:{"sky-type":"atmosphere","sky-atmosphere-sun-intensity":12}});

  map.addSource("route",{type:"geojson",data:{type:"FeatureCollection",features:[]}});
  map.addLayer({id:"route-line",type:"line",source:"route",
    paint:{"line-color":"#EC2629","line-width":4,"line-opacity":0.95}});

  await addArrow();

  map.addLayer({id:"route-arrows",type:"symbol",source:"route",
    layout:{
      "symbol-placement":"line",
      "symbol-spacing":110,
      "icon-image":"arrow",
      "icon-size":0.45,
      "icon-allow-overlap":true,
      "icon-ignore-placement":true,
      "icon-rotation-alignment":"map"
    },
    paint:{"icon-opacity":0.9}
  });

  map.addSource("cursor",{type:"geojson",data:turf.point([0,0])});
  map.addLayer({id:"cursor-pt",type:"circle",source:"cursor",
    paint:{
      "circle-radius":6,
      "circle-color":"#fff",
      "circle-stroke-width":3,
      "circle-stroke-color":"#EC2629"
    }
  });

  const text=await fetchText(GPX_URL);
  const line=parseGpx(text);

  if(line){
    const len=turf.length(line,{units:"kilometers"});
    const pts=[];
    for(let d=0;d<=len;d+=STEP_KM){
      pts.push(turf.along(line,Math.min(d,len),{units:"kilometers"}).geometry.coordinates);
    }
    route={type:"Feature",geometry:{type:"LineString",coordinates:pts}};
    routeLen=len;

    map.getSource("route").setData(route);
    map.getSource("cursor").setData(turf.point(pts[0]));

    map.once("idle",()=>{
      const b=turf.bbox(route);
      map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{
        padding:80,pitch:75,bearing:-20,duration:0
      });
    });
  }

  requestAnimationFrame(tick);
});

/* Buttons */
document.getElementById("btnToggle").onclick=()=>{
  playing=!playing;
  document.getElementById("iconPlay").classList.toggle("active",!playing);
  document.getElementById("iconPause").classList.toggle("active",playing);
};

const btnCam=document.getElementById("btnCam");
function camIcons(){
  return{
    follow:document.getElementById("iconCamCine"),
    topdown:document.getElementById("iconCamBird"),
    free:document.getElementById("iconCamFree")
  };
}

btnCam.onclick=()=>{
  camMode=camMode==="follow"?"topdown":camMode==="topdown"?"free":"follow";
  const icons=camIcons();
  Object.values(icons).forEach(i=>i.classList.remove("active"));
  icons[camMode].classList.add("active");
  if(camMode!=="free")userOverride=false;
};

/* Speed button + slider */
const speedWrap=document.getElementById("speedWrap");
document.getElementById("btnSpeed").onclick=e=>{
  e.stopPropagation();
  speedWrap.classList.toggle("open");
};
document.addEventListener("click",()=>speedWrap.classList.remove("open"));

["dragstart","rotatestart","zoomstart","pitchstart"].forEach(ev=>{
  map.on(ev,e=>{
    if((camMode==="follow"||camMode==="topdown")&&e.originalEvent){
      userOverride=true;
    }
  });
});

/* Animation loop */
function tick(ts){
  if(!lastTs) lastTs=ts;
  const dt=(ts-lastTs)/1000;
  lastTs=ts;

  if(playing&&route){
    const speed=parseFloat(document.getElementById("speed").value||"0.35");
    progress+=speed*dt*0.28;
    if(progress>routeLen)progress=0;

    const pos=turf.along(route,progress,{units:"kilometers"}).geometry.coordinates;
    const nxt=turf.along(route,Math.min(progress+0.01,routeLen),{units:"kilometers"}).geometry.coordinates;

    map.getSource("cursor").setData(turf.point(pos));

    if((camMode==="follow"||camMode==="topdown")&&!userOverride){
      const targetCenter=pos;
      const targetBearing=turf.bearing(turf.point(pos),turf.point(nxt));
      const targetPitch=camMode==="topdown"?0:75;

      if(camBearing===null)camBearing=targetBearing;
      const diff=((targetBearing-camBearing+540)%360)-180;
      camBearing+=Math.max(-MAX_TURN_RATE*dt,Math.min(MAX_TURN_RATE*dt,diff));

      if(!camCenter)camCenter=targetCenter;
      camCenter=[
        camCenter[0]+(targetCenter[0]-camCenter[0])*CENTER_SMOOTH,
        camCenter[1]+(targetCenter[1]-camCenter[1])*CENTER_SMOOTH
      ];

      map.jumpTo({
        center:camCenter,
        bearing:camBearing,
        pitch:targetPitch,
        zoom:START_ZOOM
      });
    }
  }

  requestAnimationFrame(tick);
}
</script>
</body>
</html>



