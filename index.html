<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Eryri Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { margin:0; height:100% }
    #map { position:absolute; inset:0 }

    .marker{ cursor:pointer !important }
    .marker svg{ transform:scale(0.85); transform-origin:center }

    .mapboxgl-popup{ filter:drop-shadow(0 14px 28px rgba(0,0,0,.45)); }
    .mapboxgl-popup-tip{ display:none !important; }

    .mapboxgl-popup-content{
      background:transparent !important;
      border:none !important;
      padding:0 !important;
      box-shadow:none !important;
      width:auto !important;
      overflow:visible !important;
      display:block;
      box-sizing:border-box;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif !important;
      text-transform:capitalize;
    }

    /* ===== DESKTOP POPUP (ERYRI ORIGINAL) ===== */
    .popup-card{
      display:flex;
      align-items:stretch;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      width:fit-content;
      height:130px;
    }
    .img-wrap{
      width:140px; flex:0 0 140px; height:100%;
      border-radius:12px 0 0 12px;
      overflow:hidden;
      background:#000;
    }
    .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block }

    .popup-body{
      box-sizing:border-box;
      padding:8px 12px 10px 10px;
      flex:0 0 140px;
      min-width:140px; max-width:140px;
      text-align:center;
      display:flex; flex-direction:column;
      justify-content:center;
      line-height:1.2;
      transform:translateY(-1px);
    }

    .popup-heading{ font-weight:800; font-size:11px; margin:2px 0 6px 0; color:#1E1E1E }
    .specs{ font-size:10px; display:flex; flex-direction:column; gap:3px; align-items:center; margin-top:2px; transform:translateY(1px); }
    .stats-group{ display:flex; flex-direction:column; gap:3px; align-items:center; transform:translateY(-2px); }
    .links-group{ display:flex; flex-direction:column; gap:3px; align-items:center; }
    .spec-row{ display:flex; align-items:center; justify-content:center; gap:4px }

    .icon{ width:16px; height:16px }
    .icon-red{ color:#EC2629 }
    .icon-blue{ color:#3899EC }
    .icon-img{
      width:12px; height:12px; display:block;
      filter: invert(41%) sepia(97%) saturate(1476%) hue-rotate(191deg) brightness(96%) contrast(101%)
    }

    .spec-value{ font-weight:800; color:#EC2629; font-size:11px }
    .popup-link{ color:#3899EC; font-weight:800; font-size:11px; text-decoration:none }
    .hike-gap{ margin-top:2px }

    /* ===== MOBILE POPUP ===== */
    @media(max-width:440px){
      .popup-card{ height:115px !important }
      .img-wrap{ width:105px !important; flex-basis:105px !important; height:115px !important }
      .popup-body{
        flex:0 0 105px !important;
        min-width:105px !important;
        max-width:105px !important;
        padding:4px 6px !important;
      }

      .popup-heading{ font-size:9.5px !important }
      .specs{ font-size:8.5px !important }
      .spec-value{ font-size:9.5px !important }
      .popup-link{ font-size:10px !important }
      .icon{ width:11px !important; height:11px !important }
      .icon-img{ width:9px !important; height:9px !important }
    }

    /* ===== FULLSCREEN MOBILE POPUP ===== */
    @media(max-width:440px){
      body.ios-fullscreen .popup-card{ height:calc(115px * 1.15) !important }
      body.ios-fullscreen .img-wrap{
        width:calc(105px * 1.15) !important;
        flex-basis:calc(105px * 1.15) !important;
        height:calc(115px * 1.15) !important;
      }
      body.ios-fullscreen .popup-body{
        flex:0 0 calc(105px * 1.15) !important;
        min-width:calc(105px * 1.15) !important;
        max-width:calc(105px * 1.15) !important;
        padding:calc(4px * 1.15) calc(6px * 1.15) !important;
      }

      body.ios-fullscreen .popup-heading{ font-size:calc(9.5px * 1.15) !important }
      body.ios-fullscreen .specs{ font-size:calc(8.5px * 1.15) !important }
      body.ios-fullscreen .spec-value{ font-size:calc(9.5px * 1.15) !important }
      body.ios-fullscreen .popup-link{ font-size:calc(10px * 1.15) !important }
      body.ios-fullscreen .icon{ width:calc(11px * 1.15) !important; height:calc(11px * 1.15) !important }
      body.ios-fullscreen .icon-img{ width:calc(9px * 1.15) !important; height:calc(9px * 1.15) !important }
    }

    /* ===== REMOVE TAP/FOCUS ===== */
    .popup-link,
    .popup-link:focus,
    .popup-link:active,
    .popup-link:focus-visible{
      background:transparent !important;
      outline:none !important;
      border:none !important;
      box-shadow:none !important;
    }

    .popup-link, .popup-link *{
      -webkit-tap-highlight-color:transparent !important;
      -webkit-touch-callout:none !important;
      -webkit-user-select:none !important;
    }

    /* ===== BOTTOM RIGHT STACK (MATCH PEAK DISTRICT) ===== */
    .mapboxgl-ctrl-bottom-right{
      display:flex !important;
      flex-direction:column !important;
      align-items:flex-end !important;
      gap:6px !important;
    }

    .mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-group,
    .mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-fullscreen{
      order:1;
    }

    .mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-attrib{
      order:2;
    }

    /* ===== ATTRIBUTION OFFSET ===== */
    .mapboxgl-ctrl-attrib{
      transform: translate(-1px, 3px);
    }
  </style>
</head>

<body>
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>

<script>
mapboxgl.accessToken="pk.eyJ1IjoicmVtbWlhZ2JlYmkiLCJhIjoiY21odHRrYTQzMTk0bjJqcjE1b2xhZ2FraSJ9.nTCz33gX0gQt3T4A6VD0oQ";

const RED="#EC2629", BLUE="#3899EC";

const IMG={
  snowdon:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/main/images/snowdon-toposcope.jpeg",
  idwal:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/main/images/llyn-cwm-idwal.jpg",
  llynDinas:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/main/images/llyn-dinas.jpg"
};

const hikes=[
  {
    id:"snowdon-llanberis",
    name:"Snowdon Via The Llanberis Path",
    coords:[-4.118924210708925,53.11664400159144],
    hikeUrl:"https://www.thelostpeak.co.uk/eryri-hikes/yr-wyddfa-via-the-llanberis-path-hike",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=53.11664400159144,-4.118924210708925",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/refs/heads/main/gpx/Snowdon%20Via%20The%20Llanberis%20Path.gpx",
    photo:IMG.snowdon,
    specs:{ duration:"5 to 7 hours", length:"9 miles", ascent:"975m" }
  },
  {
    id:"cwm-idwal",
    name:"Cwm Idwal Hike",
    coords:[-4.020596516220583,53.12408370096376],
    hikeUrl:"https://www.thelostpeak.co.uk/eryri-hikes/cwm-idwal-hike",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=53.12408370096376,-4.020596516220583",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/refs/heads/main/gpx/Cwm%20Idwal%20Hike.gpx",
    photo:IMG.idwal,
    specs:{ duration:"1.5 to 2.5 hours", length:"3 miles", ascent:"200m" }
  },
  {
    id:"aberglaslyn",
    name:"Aberglaslyn, Llyn Dinas & Beddgelert",
    coords:[-4.091522763013294,52.99473100666257],
    hikeUrl:"https://www.thelostpeak.co.uk/eryri-hikes/aberglaslyn-and-llyn-dinas-hike",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=52.99473100666257,-4.091522763013294",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/refs/heads/main/gpx/Aberglaslyn%2C%20Llyn%20Dinas%20%26%20Beddgelert.gpx",
    photo:IMG.llynDinas,
    specs:{ duration:"2 to 3 hours", length:"4.5 miles", ascent:"220m" }
  }
];

const map=new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/satellite-streets-v12",
  center:[-4.02,53.08],
  zoom:10,
  attributionControl:false
});

const isMobileAttribution = window.innerWidth <= 440;

map.addControl(
  new mapboxgl.AttributionControl({ compact: isMobileAttribution }),
  "bottom-right"
);

const nav=new mapboxgl.NavigationControl({ showCompass:true, showZoom:true });
map.addControl(nav,"bottom-right");
map.addControl(new mapboxgl.FullscreenControl(),"bottom-right");

/* ===== FULLSCREEN (iOS) ===== */
function isIOS(){
  const ua=navigator.userAgent||"";
  const platform=navigator.platform||"";
  return /iPad|iPhone|iPod/.test(ua)||(platform==="MacIntel"&&navigator.maxTouchPoints>1);
}
const params=new URLSearchParams(location.search);

if(isIOS()&&params.get("fs")==="1"){
  document.body.classList.add("ios-fullscreen");
  const hide=()=>{ const el=document.querySelector('.mapboxgl-ctrl-fullscreen'); if(el) el.style.display='none'; };
  hide(); setTimeout(hide,500);
}

function addIOSFullscreenButton(){
  if(!isIOS())return;
  if(params.get("fs")==="1")return;

  const corner=document.querySelector('.mapboxgl-ctrl-bottom-right');
  if(!corner)return;

  const group=[...corner.querySelectorAll('.mapboxgl-ctrl-group')]
    .find(g=>g.querySelector('.mapboxgl-ctrl-zoom-in'));
  if(!group)return;

  const btn=document.createElement('button');
  btn.className='mapboxgl-ctrl-icon ios-fs-btn';
  btn.innerHTML=`
    <svg viewBox="0 0 24 24">
      <polyline points="4,9 4,4 9,4" fill="none" stroke="#000" stroke-width="2"/>
      <polyline points="20,9 20,4 15,4" fill="none" stroke="#000" stroke-width="2"/>
      <polyline points="4,15 4,20 9,20" fill="none" stroke="#000" stroke-width="2"/>
      <polyline points="20,15 20,20 15,20" fill="none" stroke="#000" stroke-width="2"/>
    </svg>`;

  const zoomOut=group.querySelector('.mapboxgl-ctrl-zoom-out');
  const compass=group.querySelector('.mapboxgl-ctrl-compass');

  if(zoomOut){
    group.insertBefore(btn,compass||zoomOut.nextSibling);
  }else{
    group.appendChild(btn);
  }

  btn.onclick=()=>{
    const url=new URL(location.href);
    url.searchParams.set("fs","1");
    window.open(url.toString(),"_blank");
  };
}

map.on("load",addIOSFullscreenButton);

/* ===== ICONS ===== */
const icons={
  clock:`<svg class="icon icon-red" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>`,
  length:`<svg class="icon icon-red" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8h18M3 16h18"/><path d="M6 8v8M10 8v8M14 8v8M18 8v8"/></svg>`,
  ascent:`<svg class="icon icon-red" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20h18"/><path d="M6 18l5-6 4 4 5-7"/><path d="M20 7h-5v5"/></svg>`,
  walk:`<img class="icon-img" src="https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/main/icons/walking-person-go-walk-move-svgrepo-com.svg">`,
  directions:`<img class="icon-img" src="https://raw.githubusercontent.com/remmiagbebi-beep/eryri-map/main/icons/marker-svgrepo-com.svg">`
};

function specsHTML(s,u){
  return `
    <div class="specs">
      <div class="stats-group">
        <div class="spec-row">${icons.clock}<span class="spec-value">${s.duration}</span></div>
        <div class="spec-row">${icons.length}<span class="spec-value">${s.length}</span></div>
        <div class="spec-row">${icons.ascent}<span class="spec-value">${s.ascent}</span></div>
      </div>
      <div class="links-group">
        <div class="spec-row hike-gap">${icons.walk}<a class="popup-link" href="${u.hikeUrl}">Hike Page</a></div>
        <div class="spec-row">${icons.directions}<a class="popup-link" href="${u.directionsUrl}" target="_blank" rel="noopener">Directions</a></div>
      </div>
    </div>`;
}

function popupHtmlFor(h){
  return `
    <div class="popup-card">
      <div class="img-wrap"><img src="${h.photo}" alt="${h.name}"></div>
      <div class="popup-body">
        <div class="popup-heading">${h.name}</div>
        ${specsHTML(h.specs,{hikeUrl:h.hikeUrl,directionsUrl:h.directionsUrl})}
      </div>
    </div>`;
}

async function loadGpx(url){
  const res=await fetch(url);
  const xml=new DOMParser().parseFromString(await res.text(),"text/xml");
  const gj=toGeoJSON.gpx(xml);
  return gj.features.find(f=>f.geometry?.type==="LineString");
}

const routeLayerId={};
const markerElsById={};
let hoveredId=null;

function setMarkerColor(id,c){
  const el=markerElsById[id];
  if(!el)return;
  const p=el.querySelector("svg path");
  if(p)p.setAttribute("fill",c);
}

function setRouteColor(id,c){
  const lyr=routeLayerId[id];
  if(lyr&&map.getLayer(lyr))map.setPaintProperty(lyr,"line-color",c);
}

function applyHoverState(){
  Object.keys(routeLayerId).forEach(id=>setRouteColor(id,RED));
  Object.keys(markerElsById).forEach(id=>setMarkerColor(id,RED));
  if(hoveredId){
    setRouteColor(hoveredId,BLUE);
    setMarkerColor(hoveredId,BLUE);
    map.getCanvas().style.cursor="pointer";
  }else{
    map.getCanvas().style.cursor="";
  }
}

function setHovered(id){
  hoveredId=id;
  applyHoverState();
}

function addRoute(id,line){
  const src=`route-src-${id}`;
  const lyr=`route-lyr-${id}`;

  if(!map.getSource(src))
    map.addSource(src,{type:"geojson",data:line});

  if(!map.getLayer(lyr))
    map.addLayer({
      id:lyr,
      type:"line",
      source:src,
      paint:{
        "line-color":RED,
        "line-width":3,
        "line-opacity":0.95,
        "line-color-transition":{duration:0}
      }
    });

  routeLayerId[id]=lyr;
}

map.on("load",async()=>{
  const bounds=new mapboxgl.LngLatBounds();

  hikes.forEach(h=>{
    const popup=new mapboxgl.Popup({offset:22,closeButton:false}).setHTML(popupHtmlFor(h));
    const marker=new mapboxgl.Marker({color:RED}).setLngLat(h.coords).setPopup(popup).addTo(map);
    const el=marker.getElement();
    el.classList.add("marker");
    markerElsById[h.id]=el;
    el.addEventListener("mouseenter",()=>setHovered(h.id));
    el.addEventListener("mouseleave",()=>setHovered(null));
    bounds.extend(h.coords);
  });

  for(const h of hikes){
    try{
      const line=await loadGpx(h.gpx);
      if(line){
        addRoute(h.id,line);
        line.geometry.coordinates.forEach(c=>bounds.extend(c));
        map.on("mouseenter",routeLayerId[h.id],()=>setHovered(h.id));
        map.on("mouseleave",routeLayerId[h.id],()=>setHovered(null));
      }
    }catch(e){}
  }

  const isMobile=window.innerWidth<600;
  map.fitBounds(bounds,{padding:isMobile?30:110,maxZoom:isMobile?14:10});

  if(isMobile){
    map.once("idle",()=>{ if(map.getZoom()>11.6) map.setZoom(11.6); });
  }
});
</script>
</body>
</html>
